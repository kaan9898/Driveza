<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Driveza | Admin Vehicles</title>

    <link rel="stylesheet" th:href="@{/css/driveza-app.css}">
    <style>
        /* ✅ Next-level background (no blur) */
        body {
            min-height: 100vh;
            margin: 0;
            background: url('/images/user-bg.jpg') no-repeat center center fixed;
            background-size: cover;
            position: relative;
            overflow-x: hidden;
        }

        /* ✅ Dark overlay for readability (NO blur) */
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            z-index: 0;
            pointer-events: none;
        }

        /* ✅ Keep everything above overlay */
        header, main, .modalBackdrop {
            position: relative;
            z-index: 1;
        }

        /* ✅ Smooth entrance animation for page */
        header.topbar, main.container {
            animation: fadeUp .35s ease-out;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Clickable row */
        .clickRow { cursor: pointer; }
        .clickRow:hover {
            transform: translateY(-2px);
            transition: .15s;
            background: rgba(255,255,255,.04);
        }

        /* Modal */
        .modalBackdrop{
            position: fixed; inset: 0;
            background: rgba(0,0,0,.65);
            display: none;
            align-items: center; justify-content: center;
            z-index: 9999;
            padding: 18px;
            animation: fadeIn .2s ease-out;
        }
        .modalBackdrop.show{ display:flex; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modalBox{
            width: min(820px, 100%);
            max-height: 85vh;
            overflow: auto;
            border-radius: 14px;
            animation: pop .18s ease-out;
        }

        @keyframes pop {
            from { transform: scale(.97); opacity: .7; }
            to { transform: scale(1); opacity: 1; }
        }

        .modalHeader{
            display:flex;
            align-items:center;
            justify-content: space-between;
            gap: 12px;
        }

        .modalClose{
            border: none;
            background: transparent;
            font-size: 22px;
            line-height: 1;
            cursor: pointer;
        }

        .twoCol{
            display: grid;
            grid-template-columns: repeat(2, minmax(0,1fr));
            gap: 14px;
        }

        @media (max-width: 720px){
            .twoCol{ grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>

<header class="topbar">
    <div class="topbar__left">
        <a class="brand" th:href="@{/admin/dashboard}">
            <img class="brand__logo" th:src="@{/images/logo.svg}" alt="Driveza"/>
            <span class="brand__name">Driveza Admin</span>
        </a>
    </div>

    <nav class="topbar__nav">
        <a class="nav__link" th:href="@{/admin/dashboard}">Dashboard</a>
        <a class="nav__link nav__link--active" th:href="@{/admin/vehicles}">Vehicles</a>
    </nav>

    <div class="topbar__right">
        <form th:action="@{/logout}" method="post">
            <button class="btn btn--ghost" type="submit">Logout</button>
        </form>
    </div>
</header>

<main class="container">

    <section class="pageHead">
        <div>
            <h1 class="pageTitle">Vehicles</h1>
            <p class="pageSub">Click a row to edit or delete</p>
        </div>

        <div>
            <a class="btn" th:href="@{/admin/vehicles/new}">+ Add Vehicle</a>
        </div>
    </section>

    <section class="card pad">
        <table class="table" style="width:100%">
            <thead>
            <tr>
                <th>#</th>
                <th>Brand</th>
                <th>Model</th>
                <th>Type</th>
                <th>Status</th>
                <th>Price/min</th>
                <th>Lat</th>
                <th>Lon</th>
            </tr>
            </thead>

            <tbody>
            <tr th:if="${#lists.isEmpty(vehicles)}">
                <td colspan="8" class="muted">No vehicles found.</td>
            </tr>

            <tr class="clickRow"
                th:each="v, stat : ${vehicles}"
                th:attr="
            data-id=${v.id},
            data-modelid=${v.model != null ? v.model.id : 0},
            data-brand=${v.model != null ? v.model.brand : ''},
            data-model=${v.model != null ? v.model.model : ''},
            data-type=${v.type},
            data-status=${v.status},
            data-price=${v.pricePerMin},
            data-lat=${v.latitude},
            data-lon=${v.longitude}
          "
                onclick="openVehicleModal(this)">
                <td th:text="${stat.count}">1</td>

                <td th:text="${v.model != null ? v.model.brand : '—'}">Toyota</td>
                <td th:text="${v.model != null ? v.model.model : '—'}">Prius</td>

                <td th:text="${v.type}">CAR</td>
                <td th:text="${v.status}">AVAILABLE</td>
                <td th:text="${v.pricePerMin}">0.25</td>
                <td th:text="${v.latitude}">56.9</td>
                <td th:text="${v.longitude}">24.1</td>
            </tr>
            </tbody>
        </table>
    </section>

</main>

<!-- ✅ Modal -->
<div id="vehicleModal" class="modalBackdrop" onclick="backdropClose(event)">
    <div class="modalBox card pad" onclick="event.stopPropagation()">

        <div class="modalHeader">
            <div>
                <h2 style="margin:0">Edit Vehicle</h2>
                <div class="muted" id="modalSub">—</div>
            </div>
            <button class="modalClose" onclick="closeVehicleModal()" aria-label="Close">×</button>
        </div>

        <hr style="opacity:.2; margin:14px 0;"/>

        <!-- ✅ Edit form (NOT nested) -->
        <form id="editForm" method="post">
            <!-- ✅ CSRF -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <div class="twoCol">

                <div class="field">
                    <label class="label">Brand</label>
                    <input class="input" id="brand" type="text" readonly>
                </div>

                <div class="field">
                    <label class="label">Model</label>
                    <input class="input" id="model" type="text" readonly>
                </div>

                <!-- ✅ IMPORTANT: keep model relation -->
                <input type="hidden" id="modelId" name="model.id">

                <div class="field">
                    <label class="label">Type</label>
                    <select class="select" id="type" name="type" required>
                        <option value="CAR">CAR</option>
                        <option value="PREMIUM_CAR">PREMIUM CAR</option>
                        <option value="MOTORCYCLE">MOTORCYCLE</option>
                    </select>
                </div>

                <div class="field">
                    <label class="label">Status</label>
                    <select class="select" id="status" name="status" required>
                        <option value="AVAILABLE">AVAILABLE</option>
                        <option value="RENTED">RENTED</option>
                        <option value="OUT_OF_SERVICE">OUT_OF_SERVICE</option>
                    </select>
                </div>

                <div class="field">
                    <label class="label">Price per minute (€)</label>
                    <input class="input" id="pricePerMin" name="pricePerMin" type="number" step="0.01" min="0" required>
                </div>

                <div class="field">
                    <label class="label">Latitude</label>
                    <input class="input" id="latitude" name="latitude" type="number" step="0.000001" required>
                </div>

                <div class="field">
                    <label class="label">Longitude</label>
                    <input class="input" id="longitude" name="longitude" type="number" step="0.000001" required>
                </div>

            </div>

            <div style="display:flex; gap:10px; margin-top:16px; flex-wrap: wrap;">
                <button class="btn" type="submit">Save Changes</button>
                <button class="btn btn--ghost" type="button" onclick="closeVehicleModal()">Cancel</button>
            </div>
        </form>

        <!-- ✅ Delete form (separate) -->
        <form id="deleteForm" method="post" style="margin-top:10px;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button class="btn btn--danger" type="submit">Delete Vehicle</button>
        </form>

    </div>
</div>

<script>
    function openVehicleModal(row){
        const id = row.dataset.id;

        document.getElementById('brand').value = row.dataset.brand || '';
        document.getElementById('model').value = row.dataset.model || '';

        document.getElementById('modelId').value = row.dataset.modelid || 0;

        document.getElementById('type').value = row.dataset.type || 'CAR';
        document.getElementById('status').value = row.dataset.status || 'AVAILABLE';

        document.getElementById('pricePerMin').value = row.dataset.price || 0;
        document.getElementById('latitude').value = row.dataset.lat || 0;
        document.getElementById('longitude').value = row.dataset.lon || 0;

        document.getElementById('modalSub').textContent =
            `Vehicle ID: ${id} • ${row.dataset.brand} ${row.dataset.model}`;

        document.getElementById('editForm').action = `/admin/vehicles/${id}/edit`;
        document.getElementById('deleteForm').action = `/admin/vehicles/${id}/delete`;

        document.getElementById('vehicleModal').classList.add('show');
    }

    function closeVehicleModal(){
        document.getElementById('vehicleModal').classList.remove('show');
    }

    function backdropClose(){
        closeVehicleModal();
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeVehicleModal();
    });
</script>

</body>
</html>